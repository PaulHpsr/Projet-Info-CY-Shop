#include <math.h>
#include <stdio.h>
#include <string.h>
#include <time.h>
#include <stdlib.h> 
#include<dirent.h>
#include "ReadSpecificLine.h"
#include "ReadSpecificLine2.h"

typedef struct {
int pid;
char pname[20];
int pprice;

}Bill;

typedef struct {
    char name[20];
    char prenom[30];
    int age;
    char password[100];
    char email[100];
    Bill bill;
}Client;

typedef struct{
int id;
char name[20];
int price;
int qty;
}Product;

//Admin
char admin[7] = "@admin.";
char adminp[10] = "TeamBurger";
//Signup
int ch;
int choice,x, confirm;
char t_name[100], t_password1[100];
char t_password2[100], t_email[100];
char t_prenom[100];
int t_age;
int i, j=0, count =0, i, flag=1, sucess=0;
//Signup Declaration
void signup();
void account_validate();
int validate();
int login();
//Manage Declaration
int getID();
int billFileNo();
void manageProduct();
void purchaseProduct();
void generateBill();
void addProduct();
void displayAllProduct();
int findProduct();
void updateProduct();

char fproduct[]={"product.txt"};
char fbill[]={"bill.txt"};
int total =0;
//

// Signup function declared
void signup()
{
  
    printf("\n\n\t******************"
           "Welcome to Signup "
           "Page****************"
           "*\n\n");
  
    // Taking name as input
    printf("\tEnter Your name : ");
    scanf("%s", t_name);
  
      printf("\tEnter Your prenom : ");
    scanf("%s", t_prenom);
    // Taking email as input
    printf("\tEnter Your Email : ");
    scanf("%s", t_email);
  
    // Taking password as input
    printf("\tEnter Password : ");
    scanf("%s", t_password1);
  
    // Taking Confirm Password as input
    printf("\tConfirm Password : ");
    scanf("%s", t_password2);
  
    // Taking Age as input
    printf("\tEnter Your Age : ");
    scanf("%d", &t_age);
  
    x = validate();
    if (x == 1) {
  
        // Calling account_validate to check
        // if entered details follows the defined
        // rules
        account_validate();
  
        // login function appears
        login();
    }
}

// Signup process
int validate(){
  //Nom
  for(i=0; t_name[i]!= '\0';i++){
    if(!((t_name[i] >= 'a' && t_name[i] <= 'z') || (t_name[i] >= 'A' && t_name[i] <= 'Z'))) {
                  printf("\nPlease enter the valid Name!\n");
            flag = 0;
            break;
    }
  }
  //Prenom
    for(i=0; t_prenom[i]!= '\0';i++){
    if(!((t_prenom[i] >= 'a' && t_prenom[i] <= 'z') || (t_prenom[i] >= 'A' && t_prenom[i] <= 'Z'))) {
                  printf("\nPlease enter the valid Name!\n");
            flag = 0;
            break;
    }
  }
  //Other
  if(flag==1){
    count =0;
    //Email ID
    for(i=0;t_email[i]!='\0';i++){
                  if (t_email[i] == '@' || t_email[i] == '.'){ 
                count++;
        }

    }
    //Password and Age
    if(count>=2){
      if (!strcmp(t_password1, t_password2)) {
        if (t_age != 0 && t_age > 0) {
        sucess=1;
          
      }
        else{
            printf("\n\nPlease Enter the valid age\n\n");
          return 0;
        }
    }
      else{
        printf("\nPassword Mismatch\n\n");
        return 0;
      }
  }
  else {
  printf("\nPlease Enter Valid E-Mail\n\n");
  return 0;
        }
 }
  return sucess;
}

void account_validate()
{
  FILE *fc;
  Client client;
  int validate;
  //
char *fname = malloc(sizeof(char)*200);
 strcpy(fname, t_email);
strcat(fname,".txt");
    DIR *d;
    struct dirent *dir;
    d = opendir(".");
    if (d)
    {
        while ((dir = readdir(d)) != NULL)
        {
          if(dir->d_name == fname){
            printf("Compte existant, veuillez vous connecter\n\n");
            validate =0;
          }
          else{
            validate =1;
          }
        }
        closedir(d);
    }

  
 //
  if(validate ==1){
    
fc=fopen(fname,"a");
strcpy(client.name,t_name);
strcpy(client.email,t_email);
strcpy(client.prenom,t_prenom);
client.age=t_age;
strcpy(client.password,t_password1);
    //dans le fichier
fprintf(fc,"Nom: %s\nPrenom: %s\nAge: %d\n%s\nEmail: %s",client.name,client.prenom,client.age,client.password,client.email);
  fclose(fc);
  }
  printf("Compte bien créé\n\n");
  free(fname);
 }

//Login / Admin compte
int login()
{
  int a;
  FILE *fc;
  char *email = malloc(sizeof(char)*50);
   char email2[5]=".txt"; 
  char pasword[30];
  char pasword2[30];
    printf("\n\n\t******************"
           "Welcome to Login "
           "Page********************"
           "****\n\n");
    printf("\n\nLOGIN\n\n");
    printf("\t Enter Your Email: ");
  
    // Askinf for email
    scanf("%s", email);
    printf("\t Enter Your Password: ");
  
    // Asking for your Password
    scanf("%s", pasword2);
  strcat(email,email2);
  
  fc=fopen(email,"r");
  if(fc==NULL){
        printf("\nAAZAZAZ\n");
    a= -1;
  }
  strcpy(pasword, ReadLine(4, email));
  printf("%s\n",pasword);
  
  if((strcmp(pasword2, pasword))){
    printf("\nVous êtes bien connecté\n");
    a= 1;
  }
    else if(email == admin){
      if((strcmp(pasword2, adminp))){
        a= 2;
      }
    }
  else{
    printf("\nMauvais Mot de passe ou adresse email\nVeuillez vous créer un compte");
    a= -1;
  }
  free(email);
  return a;
}

//Manage
void manageProduct(){
  int ch;
  int back=0;
  while(1){

    printf("============\n\n");
    printf("\t\t Welcome Management\n\n");
    printf("================\n\n");
    printf("1.Add\n\n");
    printf("2.Display\n\n");
    printf("3.Modif les stocks\n\n");
    printf("0.Back\n\n");
    printf("==============\n\n");
    printf("\nPlease enter your Choice:");
    scanf("%d",&ch);

    switch(ch){
      case 1: addProduct();
      break;
      case 2: displayAllProduct();
      break;
      case 3: updateProduct();
      break;
      case 0: 
      break;
      default :
      printf("veuillez renter un choix valide");
      break;
    }
  }
}

void displayAllProduct(){
  Product t7;
  int id;

  printf("\n==============\n\n");
  printf("\t\t Product Details\n\n");
  printf("================\n\n");

  printf("ID\tName\tPrice\tQty\n\n");
for(int j=0;j<findProduct();j++){
  id=1+(i*5);
  t7.id=ReadLineNbr(id,"product.txt");

  
    printf("%d\t",t7.id);

}
  }


void addProduct(){
  FILE *fp;
  Product t1;
  fp=fopen(fproduct,"a");

  t1.id=getID();
  printf("\nEnter product name:");
  scanf("%s",t1.name);
  printf("\nEnter propduct price:");
  scanf("%d",&t1.price);
  printf("\nEnter product qty:");
  scanf("%d",&t1.qty);

  fprintf(fp,"%d\n%s\n%d\n%d\n---------------------\n", t1.id,t1.name,t1.price,t1.qty);
  fclose(fp);
}

int getID(){
  FILE *fp;
  int value=0;
  fp=fopen("prodid.txt","r");
  if(fp==NULL){
    fp=fopen("prodid.txt","w");
    fprintf(fp,"%d",0);
    fclose(fp);
    fp=fopen("prodid.txt","r");
  }
  fscanf(fp,"%d",&value);
  fclose(fp);
  fp=fopen("prodid.txt","w");
  fprintf(fp,"%d",value+1);
  fclose(fp);
  return value+1;
}

void updateProduct(){
  Product prod;
  int nouvstock;
  int idp;
  FILE *fp;
  Product trouve;
  fp=fopen(fproduct,"r");
  FILE *nfile = fopen("StocksModif.txt","w");
  printf("Quel Produit voulez vous modifier les stocks (ID) ? : \n");
  scanf("%d",&idp);
  printf("Nombre nouveau stock : \n");
  scanf("%d",&nouvstock);
Product *productcopy = malloc(sizeof(Product)*findProduct());
int compte=0;
for(i=0;i<findProduct()*5;i++){
  prod.id=ReadLineNbr((1+(i*5)),fproduct);
  prod.price=ReadLineNbr((3+(i*5)),fproduct);
  prod.qty=ReadLineNbr((4+(i*5)),fproduct);
  strcpy(prod.name,ReadLine((1+(i*5)),fproduct));

  if(prod.id != idp){
    productcopy[compte].id = prod.id;
    strcpy(productcopy[compte].name, prod.name);
    productcopy[compte].price = prod.price;
    productcopy[compte].qty = prod.qty;
    compte++;
  }
  else if(prod.id == idp){
    trouve=prod;
    trouve.qty=nouvstock;
  }
  
}
  for(i=0; i<compte;i++){
    fprintf(nfile, "ID: %d  Produit: %s  Prix: %d $  Qté: %d",productcopy[i].id,productcopy[i].name,productcopy[i].price,productcopy[i].qty);
  }
  fprintf(nfile,"ID: %d  Produit: %s  Prix: %d $  Qté: %d",trouve.id,trouve.name,trouve.price,trouve.qty);
  fclose(fp);
  fclose(nfile);
  remove("product.txt");
  rename("StockModif.txt","product.txt");
 printf("Stocks modifiés avec succès!\n\n");
 
}

int findProduct(){
int nprod;
Product produit;
FILE *fp;
fp =fopen("prodid.txt","r");
fscanf(fp, "%d", &nprod);
fclose(fp);
return nprod;
}

int GestionMode(){
    system("clear"); //clrscr();

  while(login()==1){ //faire un while login() == 2 pour admin -> Manage + Voir les clients + leurs infos.
    system("clear");
    printf("=========================\n\n");
    printf("\t\t Bie'nvenu CY-SHOP\n\n");
        printf("=========================\n\n");

    printf("1.Manage Product\n\n");
    printf("2.Purchase Product\n\n");
    printf("3.Generate Bill\n\n");
    printf("0.Exit\n\n");
    printf("=========================\n\n");
    printf("\nPlease enter your Choice:");
    scanf("%d",&ch);
switch(ch){
  case 1: manageProduct();
  break;
  case 2: 
  break;
  case 3: 
  break;
  case 0: 
  exit(0);
  default:
  printf("Erreur");
  break;
  
}
}
}

int main()
{
  FILE *fp;
    // Loop while till which runs till break is called
    while (1) {
  
        // First Page
    printf("=========================\n\n");
    printf("\t\t Bienvenu CY-SHOP\n\n");
        printf("=========================\n\n");
        printf("\n\n1)SIGNUP");
        printf("\n2)LOGIN");
        printf("\n3)EXIT");
  
        // Asking for choice
        printf("\n\n\nEnter your choice : ");
        scanf("%d", &choice);
  
  
        // Switch used to check the input
        // choice
        switch (choice) {
        case 1: {
            // Signup function called
            signup();
            break;
        }
        case 2: {
            // Login function called
            GestionMode();
            break;
        }
        case 3: {
            printf(
                "\n\t*************************Thank you "
                "Visit Again***********************\n\n");
  
            // close the program
            return 0;
        }
        default: {
  
            // Choice entered is not correct
            printf("\n\nPlease enter valid choice!!\n");
            break;
        }
        }
    }

  return 0;
}
